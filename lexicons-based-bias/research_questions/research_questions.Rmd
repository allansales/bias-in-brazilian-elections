---
title: "research_questions"
author: "Allan Sales"
date: "2 de julho de 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("../utils/mongo_utils.R")
source("../utils/search_top_rated_comments.R")

library(dplyr)
library(readr)

library(reshape2)
library(data.table)

library(gmodels)

library(wordVectors)

library(ggpubr)
library(corrplot)

library(ggpubr)
library(gridExtra)
library(grid)
```

# Functions initialization
```{r}
# get news of a theme
news_of_theme <- function(data, theme, secao, get_from_theme = T){
  true_false_vector <- data %>% select(secao) %>% 
    unlist() %>% as.vector() %>% 
    tolower() %>% str_detect(theme)
  
  if(get_from_theme){
    news <- data %>% filter(true_false_vector == TRUE)
  } else {
    news <- data %>% filter(true_false_vector == FALSE)
  }
  return(news)
}

get_bounds <- function(values){
  conf.interval = ci(values)
  data.frame(as.list(conf.interval))
}

# get cconfidence interval by year and section
get_conf_by_year_section = function(news, group_var, pattern_filter = NULL){
  if(!is.null(pattern_filter)){
    news = news %>% news_of_theme(pattern_filter, "text")  
  }
  
  melted_ratings = melt(news, id=c("text", "source", "section", "day", "month", "year"))
  conf_by_year_sec = melted_ratings %>% group_by_(.dots = group_var) %>% do(get_bounds(.$value))
  
  if(!is.null(pattern_filter)){
    conf_by_year_sec$entity = pattern_filter  
  }
  return(conf_by_year_sec)
}

subjectivity_years_section = function(data, section_name){
  data %>% filter(section %in% section_name) %>% ggplot(aes(as.factor(year), Estimate, ymin = CI.lower, ymax = CI.upper, color = source)) + geom_errorbar(position = "dodge") + facet_wrap(variable ~ ., scales="free")
}

# confidence interval plot
CI_plot = function(conf_int_data, col_discriminant){
  
  form = "year ~ source" %>% as.formula()
  
  plot <- ggplot(conf_int_data, aes(variable, Estimate, fill = get(col_discriminant))) +
    geom_errorbar(aes(ymin = CI.lower, 
                    ymax = CI.upper, 
                    color = get(col_discriminant)), 
                    width = 1, position = "dodge") +
    labs(fill = "Entity", x = "Dimension") + 
    facet_grid(form) + 
    guides(color=guide_legend(title="Entity")) + 
    theme(legend.position="bottom")
  
  plot   
}
```

# data preparation
```{r, warning=FALSE}
wiki_data = read_csv("../data/wmd/wiki_rates.csv") %>% select(-class, -Comment)
conf_wiki = melt(wiki_data) %>% group_by(variable) %>% do(get_bounds(.$value))
conf_wiki$source = "Wikipedia"

data = read_csv("../data/wmd/wmd_noticias_2010_2014.csv")
data_1 = data %>% select(-text, -arg, -sen, -mod, -pre, -val) %>% slice(2:n())
data_2 = data %>% select(text, arg, sen, mod, pre, val) %>% slice(1:(n()-1))
news = data_1 %>% bind_cols(data_2) %>% select(text, source = subFonte, day = dia, month = mes, year = ano, section = caderno, arg, sen, mod, pre, val) %>% filter(pre != -1)

data_carta_folha_complement = read_csv("../data/wmd/wmd_noticias_carta_2010-2018_folha_2018.csv")
data_estadao_complement = read_csv("../data/wmd/wmd_noticias_estadao_2018.csv")
data_estadao_complement$repercussao = data_estadao_complement$repercussao %>% as.character()

data_estadao_complement = bind_rows(data_carta_folha_complement, data_estadao_complement)

data_complement = bind_rows(data_estadao_complement, data_carta_folha_complement) %>% select(text, source = subFonte, day = dia, month = mes, year = ano, section = caderno, arg, sen, mod, pre, val) %>% filter(pre != -1)

news = bind_rows(news, data_complement)
news$section =  with(news, if_else(section == "politica", "politics",
                                                        if_else(section == "economia", "economy", if_else(section == "cultura", "culture", section))))
```

# confidence interval for data
```{r, warning=FALSE}
group_var = c("variable", "source", "year", "section")
dilma = news %>% get_conf_by_year_section(group_var, "dilma")
marina = news %>%  get_conf_by_year_section(group_var, "marina")
serra = news %>% get_conf_by_year_section(group_var, "serra")
aecio = news %>% get_conf_by_year_section(group_var, "aecio")
bolsonaro = news %>% get_conf_by_year_section(group_var, "bolsonaro")
haddad = news %>% get_conf_by_year_section(group_var, "haddad")
ciro = news %>% get_conf_by_year_section(group_var, "ciro")

conf_by_year_sec_pt = news %>% get_conf_by_year_section(group_var, "pt")
conf_by_year_sec_psdb = news %>% get_conf_by_year_section(group_var, "psdb")
conf_by_year_sec_pdt = news %>% get_conf_by_year_section(group_var, "pdt")
conf_by_year_sec_psl = news %>% get_conf_by_year_section(group_var, "psl")
```


```{r}
melted_ratings = melt(news, id=c("text", "source", "section", "day", "month", "year"))
```

# Data distribution
## Boxplot rates distribution
```{r}
sources_distribution_plot = melted_ratings %>% ggplot(aes(source, value)) + geom_boxplot() + facet_wrap(~variable)
sources_distribution_plot
```

## Density 
```{r}
density_distribution_plot = melted_ratings %>% ggplot(aes(value, color = source)) + geom_density() + facet_wrap(~variable)
density_distribution_plot
```

# Hypothesis test
## Portals
### Is there a significant difference between subjectivity rates of the text sources?
```{r, warning=FALSE}
conf_by_source = melted_ratings %>% group_by(variable, source) %>% do(get_bounds(.$value))
conf_by_year = melted_ratings %>% group_by(variable, source, year) %>% do(get_bounds(.$value))
conf_by_year_sec = melted_ratings %>% group_by(variable, source, year, section) %>% do(get_bounds(.$value))
```

```{r}
conf_by_source = conf_by_source %>% bind_rows(conf_wiki)

subjectivity_by_source = conf_by_source %>% ggplot(aes(source, Estimate, ymin = CI.lower, ymax = CI.upper, color = source)) + geom_errorbar() + facet_wrap(variable ~ ., scales="free") + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + theme(legend.position="bottom")
subjectivity_by_source
ggsave("general_subjectivity.pdf", plot = subjectivity_by_source, device = "pdf")
```

### Do the subjectivity of portals are similar though years?
```{r}
subjectivity_years = conf_by_year %>% ggplot(aes(as.factor(year), Estimate, ymin = CI.lower, ymax = CI.upper, color = source)) + geom_errorbar(position = "dodge") + facet_wrap(variable ~ ., scales="free")  + theme(axis.text.x = element_text(angle = 90, hjust = 1))
subjectivity_years
```

### Do the subjectivity of sections are similar though years?
```{r}
section_name = c("politics","economy")
formula = "section ~ variable"                                           
             
conf_by_year_sec %>% CI_plot("section")
```

## Candidates
```{r, warning=FALSE}
candidates_2010 = bind_rows(dilma, marina, serra) %>% filter(year == 2010, section == "politics")
candidates_2014 = bind_rows(dilma, marina, aecio) %>% filter(year == 2014, section == "politics")
candidates_2018 = bind_rows(haddad, bolsonaro, ciro) %>% filter(year == 2018, section == "politics")
```

### Marina - The only one participating in all elections
```{r}
p = marina %>% subjectivity_years_section("politics") + labs(x = "Year") + theme(legend.position="bottom")
ggsave("marina.pdf", plot = p, device = "pdf")
```

### Candidates vs Candidates - 2010
```{r, warning = FALSE}
p = candidates_2010 %>% CI_plot("entity")
ggsave("candidates_2010.pdf", plot = p, device = "pdf", height = 4)
```

### Candidates vs Candidates - 2014 
```{r}
p = candidates_2014 %>% CI_plot("entity")
ggsave("candidates_2014.pdf", plot = p, device = "pdf", height = 4)
```

### Candidates vs Candidates - 2018
```{r}
p = candidates_2018 %>% CI_plot("entity")
ggsave("candidates_2018.pdf", plot = p, device = "pdf", height = 4)
```

## Parties
```{r}
parties = bind_rows(conf_by_year_sec_pt, conf_by_year_sec_psdb) %>% filter(section == "politics")
parties_2018 = bind_rows(conf_by_year_sec_pt, conf_by_year_sec_psdb, conf_by_year_sec_psl) %>% filter(year == 2018, section == "politics")
```

```{r}
p = parties %>% CI_plot("entity")
ggsave("pt_psdb_subjectivity.pdf", plot = p, device = "pdf")
```

### Subjectivity on PT x PSL x PSDB 2018
```{r}
p = parties_2018 %>% CI_plot("entity")
ggsave("pt_psdb_psl_2018.pdf", plot = p, device = "pdf")
```